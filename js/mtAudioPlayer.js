var AudioCheck=new Class({initialize:function(a){},check:function(a){if(!!a){return this.canPlay(a)}return this.isSupported()},isSupported:function(){if(!!(document.createElement("audio").canPlayType)==false){return false}var b=new Audio("");return !!(!!(b.canPlayType)?b.play:false)},canPlay:function(c){if(!this.isSupported()){return false}c=c.toLowerCase();switch(c){case"mp3":c="mpeg";break;case"au":c="basic";break;case"snd":c="basic";break;case"wav":c="x-wav";break;case"aif":c="aiff";break;case"aifc":c="aiff";break}c="audio/"+c;var b=new Audio("");if(b.canPlayType){return("no"!=b.canPlayType(c))&&(""!=b.canPlayType(c))}return false}});var mtAudioPlayer=new Class({Implements:[Options,Events],options:{"class":"mtAPlayer",id:false,tracks:["sample.mp3"],parent:null,auto:false,repeat:false,onLoading:function(a){dbug.log("Loading : "+a)},onError:function(a){if(a==4){throw ("mtAudioPlayer Error: track not found, or not supported")}throw ("mtAudioPlayer Unrecognized Error; code: "+a)}},tracks:$H({}),currTrack:0,isPlaying:false,toElement:function(){return this.element},initialize:function(a){this.setOptions(a);if(this.options.parent==null){this.options.parent=document.body}this.soundCheck=new AudioCheck();if(!this.soundCheck.check()){throw ("HTML5 audio is not supported")}var b=this.pruneTracks(this.options.tracks);if(b[1].length){this.fireEvent("prune",b[1])}if(b[0].length<=0){throw ("No supported tracks found")}this.makePlayList(b[0]);this.addEvents();this.element=new Element("div",{id:this.options.id?this.options.id:"mtaudio-"+Math.floor(Math.random()*1000000000).toString(16),"class":this.options["class"]})},getMediaType:function(a){if(typeof a=="string"){return a.substring(a.lastIndexOf(".")+1)}},makePlayList:function(a){for(var b=0;b<a.length;b++){this.tracks[a[b]]={file:a[b],pos:0,audio:new Audio("")}}},pruneTracks:function(b){var d=[];var a=b.length;for(var c=0;c<a;c++){if(!this.soundCheck.check(this.getMediaType(b[c]))){d.push(b.splice(c,1))}}return[b,d]},cacheNext:function(){var b=this.currTrack+1;if(b>=this.tracks.getLength()){return}var a=this.getTrack(b);if(!a.audio.get("src")){a.audio.set("src",a.file);a.audio.load();this.fireEvent("loading",a.file)}return this},addEvents:function(){var a=this;this.tracks.each(function(b,c){b.audio.addEvent("error",function(){dbug.log("Caught Error");a.fireEvent("error",b.audio.error.code)});b.audio.addEvent("abort",function(){dbug.log("Caught Abort");a.fireEvent("abort")});b.audio.addEvent("timeupdate",function(){dbug.log("Caught timeupdate")});b.audio.addEvent("waiting",function(){dbug.log("Caught waiting")});b.audio.addEvent("ended",function(){dbug.log("ended")})})},inject:function(){this.options.parent.grab(this.element);return this},getTrack:function(a){if(!a){a=this.currTrack}if(typeof a=="number"&&a<this.tracks.getKeys().length&&a>=0){return this.tracks.get(this.tracks.getKeys()[a])}if(typeof a=="string"&&this.tracks.has(a)){return this.tracks.get(a)}throw ("Track "+a+" is not in the playlist")},addTrack:function(a){if(typeof a=="object"){if(!a.file){throw ("addTrack requires either a String or an object with a file attribute as an argument")}if(!a.audio){a.audio=new Audio("")}if(!a.pos){a.pos=0}this.tracks.set(a.file,a)}else{if(typeof a=="string"){this.tracks.set(a,{file:a,pos:0,audio:new Audio("")})}}return this},rmTrack:function(a){if(typeof a=="number"){this.tracks.erase(this.tracks.getKeys()[a])}else{this.tracks.erase(a)}return this},toggle:function(){if(this.isPlaying){this.pause();return"play"}else{this.play();return"pause"}},playReady:function(){var a=this.getTrack();if(a.audio.readyState==a.audio.HAVE_ENOUGH_DATA){if(a.pos==a.audio.duration){a.pos=0}this.seek(a.pos);a.audio.play();this.playing();$clear(this.prTimer)}},playing:function(){this.isPlaying=true;this.resetNextTimer();this.fireEvent("playing",this.getTrack().file)},play:function(a){var a=this.getTrack(a);if(!a.audio.get("src")){a.audio.set("src",a.file)}if(a.audio.readyState<=a.audio.HAVE_CURRENT_DATA){if(!this.soundCheck.check(this.getMediaType(a.file))){this.fireEvent("error",4);return}this.fireEvent("loading",a.file);a.audio.load()}this.drTimer=this.setDuration.periodical(250,this);this.srTimer=this.seek.periodical(2500,this);this.prTimer=this.playReady.periodical(250,this);this.cacheNext();return this},next:function(){this.nextTimer&&$clear(this.nextTimer);this.pause();this.currTrack++;if(this.currTrack>=this.tracks.getKeys().length){this.resetAll();this.currTrack=0}this.play()},prev:function(){this.pause();this.currTrack--;if(this.currTrack<0){this.currTrack=this.tracks.getKeys().length-1}this.play()},pause:function(){this.getTrack().pos=this.getPosition();this.getTrack().audio.pause();this.isPlaying=false;return this},stop:function(){this.getTrack().audio.pause();this.getTrack().pos=0;this.isPlaying=false;return this},resetAll:function(){this.tracks.each(function(a){a.pos=0})},resetNextTimer:function(){if(this.nextTimer){$clear(this.nextTimer);this.nextTimer=this.next.delay((this.duration-this.getPosition())*1000,this)}},setDuration:function(){var a=this.getTrack();if(a.audio.readyState>=a.audio.HAVE_METADATA){this.duration=a.audio.duration;this.drTimer&&$clear(this.drTimer)}},seek:function(b){var a=this.getTrack();if(a.audio.readyState==a.audio.HAVE_NOTHING){return}b=!!b?b:a.pos;if(!!a.audio.seekable&&a.audio.seekable.end()>=b){a.audio.currentTime=b;this.resetNextTimer();this.srTimer&&$clear(this.srTimer)}return this},getPosition:function(){return this.getTrack().audio.currentTime}});var mtAudioPlayerUI=new Class({Implements:[Options,Events],options:{id:false,"class":"mtAPlayerUI",parent:null,player:null},elems:$H({}),buttons:$H({}),toElement:function(){return this.element},initialize:function(a){this.setOptions(a);if(this.options.parent==null){this.options.parent=document.body}this.options.id=this.options.id?this.options.id:"mtaudioui-"+Math.floor(Math.random()*1000000000).toString(16);if(typeof this.options.player!="object"){throw ("A valid mtAudioPlayer object is requried")}this.player=this.options.player;this.element=new Element("div",{id:this.options.id,"class":this.options["class"]});this.buttons.toggle=new Element("a",{id:this.options.id+"_toggle",html:"play",href:"#","class":"button toggle"});this.buttons.prev=new Element("a",{id:this.options.id+"_prev",html:"&laquo;",href:"#","class":"button prev"});this.buttons.rw=new Element("a",{id:this.options.id+"_rw",html:"&larr;",href:"#","class":"rw"});this.buttons.stop=new Element("a",{id:this.options.id+"_stop",html:"&curren;",href:"#","class":"button stop"});this.buttons.ff=new Element("a",{id:this.options.id+"_ff",html:"&rarr;",href:"#","class":"ff"});this.buttons.next=new Element("a",{id:this.options.id+"_next",html:"&raquo;",href:"#","class":"button next"});this.readout=new Element("div",{id:this.options.id+"_read","class":"readout"});this.pos=new Element("span",{id:this.options.id+"_pos",html:"0:00",href:"#","class":"pos"});this.name=new Element("span",{id:this.options.id+"_name",html:"",href:"#","class":"name"});this.dur=new Element("span",{id:this.options.id+"_dur",html:"0:00",href:"#","class":"dur"});this.readout.adopt([this.pos,this.name,this.dur]);this.element.adopt(this.buttons.getValues()).adopt(this.readout);this.addEvents()},addEvents:function(){var a=this;this.buttons.toggle.addEvent("click",function(b){b.stop();var c=a.player.toggle();a.buttons.toggle.set("html",c);a.buttons.toggle.addClass(c);a.buttons.toggle.removeClass((c=="play")?"pause":"play")});this.buttons.stop.addEvent("click",function(b){b.stop();a.player.stop();a.buttons.toggle.set("html","play");$clear(this.updateTimer)});this.buttons.next.addEvent("click",function(b){b.stop();a.player.next()});this.buttons.prev.addEvent("click",function(b){b.stop();a.player.prev()});a.player.addEvent("playing",function(b){a.buttons.toggle.set("html","pause");a.updateTimer=a.updatePos.periodical(1000,a);a.dur.set("html",a.formatTime(a.player.duration));a.name.set("html",a.formatName(b))})},formatName:function(a){a=a.substring(0,a.lastIndexOf("."));if(a.indexOf("/")){return a.substring(a.indexOf("/")+1)}return a},formatTime:function(b){b=b.round();var a=(b/60).floor();b=(b%60);b=b<10?"0"+b:b;return a+":"+b},updatePos:function(){this.pos.set("html",this.formatTime(this.player.getPosition()))},inject:function(){$(this.options.parent).adopt(this.element);return this}});